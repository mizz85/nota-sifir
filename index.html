<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nota Sifir Bercakap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: #ffffff;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2); 
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);\
            box-shadow: 0 15px 30px rgba(59, 130, 246, 0.25);\
        }
        .equation {
            padding: 0.5rem 0;
            transition: background-color 0.2s;
        }
        .text-prime {
            color: #3b82f6; 
        }
        .bg-prime {
            background-color: #3b82f6;
        }
        .text-maroon {
            color: #EF4444; 
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div id="login-screen" class="w-full max-w-sm">
        <div class="bg-white p-8 rounded-xl shadow-2xl text-center">
            <h2 class="text-3xl font-extrabold text-prime mb-6">Nota Sifir Bercakap</h2>
            <div class="mb-4">
                <input type="password" id="password-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-prime" placeholder="Masukkan Kata Laluan" required>
            </div>
            <button id="login-button" class="w-full bg-prime text-white py-3 rounded-lg font-semibold hover:bg-blue-600 transition duration-200">
                Log Masuk
            </button>
            <p id="login-message" class="text-red-500 mt-4 hidden"></p>
        </div>
    </div>

    <div id="app-container" class="hidden w-full max-w-2xl">
        <div class="card p-4 md:p-8 rounded-xl">
            
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-extrabold text-gray-800">Nota Sifir Bercakap</h1>
                <button id="logout-button" class="text-sm text-gray-500 hover:text-red-500 transition duration-150 p-2 rounded-lg border border-gray-200">Log Keluar</button>
            </div>
            
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex space-x-2">
                    <button id="lang-ms-button" class="px-3 py-1 text-sm rounded-full font-medium bg-prime hover:bg-blue-600 text-white transition duration-150">ðŸ‡²ðŸ‡¾ BM</button>
                    <button id="lang-en-button" class="px-3 py-1 text-sm rounded-full font-medium bg-gray-300 hover:bg-gray-400 text-gray-800 transition duration-150">ðŸ‡¬ðŸ‡§ EN</button>
                </div>
                 <button id="tts-info-toggle" class="flex items-center text-sm text-gray-500 hover:text-prime transition duration-150">
                    <svg id="tts-info-icon" class="w-4 h-4 mr-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>TTS Info</span>
                </button>
            </div>

            <div id="tts-info-content" class="p-3 mb-4 bg-yellow-50 border border-yellow-200 text-sm text-yellow-800 rounded-lg hidden">
                <p class="font-semibold mb-1">Penting: Isu Suara TTS</p>
                <p>Jika suara BM berbunyi Inggeris atau pelik, sila pastikan anda telah <span class="font-bold">memuat turun pakej suara Bahasa Melayu</span> dalam Tetapan TTS telefon anda (Android/iOS). Pelayar web akan menggunakan suara BM yang tersedia.</p>
            </div>

            <div class="mb-6 flex justify-between items-center">
                <label for="multiplier-select" class="font-semibold text-gray-700">Pilih Sifir Darab:</label>
                <select id="multiplier-select" class="px-3 py-2 border border-gray-300 rounded-lg bg-white text-lg font-bold focus:outline-none focus:ring-2 focus:ring-prime">
                    </select>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="mode-toggle" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-3 rounded-lg font-bold transition duration-200">
                    Tukar ke Mod Kuiz
                </button>
                <div id="score-display" class="hidden bg-gray-100 p-3 rounded-lg text-center">
                    <p class="text-gray-600 font-semibold text-sm">Skor: <span id="current-score" class="text-xl font-extrabold text-green-600">0</span> / <span id="total-attempts">12</span></p>
                    <p id="remaining-questions" class="text-xs text-gray-500 mt-1">Soalan Belum Ditanya: 12</p>
                </div>
            </div>

            <div id="sifir-list" class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-inner mb-6">
                </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                <button id="prev-button" class="flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-bold transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <span>Sebelum</span>
                </button>
                
                <button id="speak-button" class="bg-prime hover:bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center transition duration-200">
                    <div id="loading-spinner" class="spinner mr-2 hidden"></div>
                    <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464A4.5 4.5 0 0117 12h-2V7.5a4.502 4.502 0 017 3.5v1c0 2.485-2.015 4.5-4.5 4.5H15l-1 4H8l-1-4H3.5A4.5 4.5 0 01-1 12v-1a4.502 4.502 0 017-3.5h1.536zM15 12H9"></path></svg>
                    <span id="speak-text">Baca Sifir Ini</span>
                </button>
                
                <button id="next-button" class="flex items-center justify-center bg-gray-200 hover:bg-gray-300 text-gray-800 py-3 rounded-lg font-bold transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span>Seterusnya</span>
                    <svg class="w-5 h-5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            
            <div class="flex justify-between items-center p-3 border-t">
                <p id="audio-message" class="text-sm text-red-500 font-medium"></p>
                <button id="sound-toggle-button" class="flex items-center px-3 py-1 rounded-full bg-green-100 hover:bg-green-200 text-green-700 transition duration-150">
                    <svg id="sound-icon-on" class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 9a1 1 0 000 2h1a1 1 0 000-2H6zm7 0h1a1 1 0 100-2h-1a1 1 0 100 2zM9 9h2a1 1 0 000-2H9a1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                    <svg id="sound-icon-off" class="w-5 h-5 mr-1 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.018a1 1 0 011.057-.156l6.5 4A1 1 0 0117 7v6a1 1 0 01-1.06.638l-6.5 4A1 1 0 019 17V3a1 1 0 01.383-.782zM12 9a1 1 0 000 2h1a1 1 0 000-2h-1zm2 0h1a1 1 0 000-2h-1a1 1 0 000 2zM10 9h2a1 1 0 000-2h-2a1 1 0 000 2z" clip-rule="evenodd"></path></svg>
                    <span id="sound-text" class="text-sm font-medium">Bunyi</span>
                </button>
            </div>
            
        </div>
    </div>
    
    <script type="module">
        // --- 1. Konfigurasi dan Pembolehubah Global ---
        const SECRET_PASSWORD = "notasifir5973"; 
        
        let currentLanguage = 'ms'; 
        
        // Pembolehubah DOM
        const LOGIN_SCREEN = document.getElementById('login-screen');
        const APP_CONTAINER = document.getElementById('app-container');
        const PASSWORD_INPUT = document.getElementById('password-input');
        const LOGIN_BUTTON = document.getElementById('login-button'); 
        const LOGIN_MESSAGE = document.getElementById('login-message');
        const LANG_MS_BUTTON = document.getElementById('lang-ms-button');
        const LANG_EN_BUTTON = document.getElementById('lang-en-button');
        const SPEAK_BUTTON = document.getElementById('speak-button');
        const SPEAK_TEXT = document.getElementById('speak-text');
        const LOADING_SPINNER = document.getElementById('loading-spinner');
        const AUDIO_MESSAGE = document.getElementById('audio-message');
        const SIFIR_LIST = document.getElementById('sifir-list');
        const PREV_BUTTON = document.getElementById('prev-button');
        const NEXT_BUTTON = document.getElementById('next-button');
        const MULTIPLIER_SELECT = document.getElementById('multiplier-select'); 
        const MODE_TOGGLE_BUTTON = document.getElementById('mode-toggle'); 
        const SCORE_DISPLAY = document.getElementById('score-display'); 
        const CURRENT_SCORE = document.getElementById('current-score'); 
        const TOTAL_ATTEMPTS = document.getElementById('total-attempts'); 
        const REMAINING_QUESTIONS = document.getElementById('remaining-questions'); 
        const SOUND_TOGGLE_BUTTON = document.getElementById('sound-toggle-button');
        const SOUND_ICON_ON = document.getElementById('sound-icon-on');
        const SOUND_ICON_OFF = document.getElementById('sound-icon-off');
        const SOUND_TEXT = document.getElementById('sound-text');
        const TTS_INFO_TOGGLE = document.getElementById('tts-info-toggle');
        const TTS_INFO_CONTENT = document.getElementById('tts-info-content');
        const TTS_INFO_ICON = document.getElementById('tts-info-icon');
        const LOGOUT_BUTTON = document.getElementById('logout-button'); 
        
        // Pembolehubah Kawalan
        let isSoundEnabled = true; 
        let isSpeaking = false;
        let isQuizMode = false; 
        let currentMultiplier = 1;
        const MIN_MULTIPLIER = 1;
        const MAX_MULTIPLIER = 12;

        let audioContext; 
        let score = 0;
        const MAX_QUESTIONS = 12; 
        let quizQuestionsLeft = []; 
        let quizTarget = null; 
        
        // --- 2. Fungsi Bantuan Bahasa & Logik ---

        function numberToEnglishWords(num) {
            if (num === 0) return 'zero';
            if (num > 1000) return num.toString(); 
            
            const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            
            if (num < 20) return units[num];
            if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + units[num % 10] : '');
            
            const h = Math.floor(num / 100);
            const rem = num % 100;
            let str = units[h] + ' hundred';
            if (rem > 0) {
                str += ' and ' + numberToEnglishWords(rem); 
            }
            return str.trim(); 
        }

        function getSpelledEnglish(num1, num2) {
            const result = num1 * num2;
            const num1Spelled = numberToEnglishWords(num1);
            const num2Spelled = numberToEnglishWords(num2);
            const resultSpelled = numberToEnglishWords(result);
            return { num1Spelled, num2Spelled, resultSpelled };
        }

        // --- 3. Logik Log Masuk & Log Keluar ---
        
        function attemptLogin() {
            if (LOGIN_BUTTON.disabled) return;
            LOGIN_BUTTON.disabled = true;

            const enteredPassword = PASSWORD_INPUT.value.trim().toLowerCase();
            
            if (enteredPassword === SECRET_PASSWORD) {
                LOGIN_SCREEN.classList.add('hidden');
                APP_CONTAINER.classList.remove('hidden');
                LOGIN_MESSAGE.classList.add('hidden');
                initApp();
            } else {
                LOGIN_MESSAGE.textContent = 'Kata laluan salah. Sila cuba lagi.';
                LOGIN_MESSAGE.classList.remove('hidden');
                PASSWORD_INPUT.value = ''; 
                PASSWORD_INPUT.focus();
            }
            
            setTimeout(() => { LOGIN_BUTTON.disabled = false; }, 500);
        }
        
        function logout() {
            stopSpeaking(); 
            
            APP_CONTAINER.classList.add('hidden');
            LOGIN_SCREEN.classList.remove('hidden');
            
            PASSWORD_INPUT.value = '';
            LOGIN_MESSAGE.classList.add('hidden');
            PASSWORD_INPUT.focus();
            
            if (isQuizMode) {
                toggleQuizMode(); 
            }
        }
        
        // --- 4. Fungsi Audio & TTS (TTS & Bunyi) ---
        
        function stopSpeaking() {
            if (window.speechSynthesis && window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            isSpeaking = false;
            
            SPEAK_TEXT.textContent = isQuizMode ? 
                (currentLanguage === 'ms' ? 'Tanya Soalan' : 'Ask Question') : 
                (currentLanguage === 'ms' ? 'Baca Sifir Ini' : 'Read Table');
                
            SPEAK_BUTTON.disabled = false;
            AUDIO_MESSAGE.textContent = '';
            LOADING_SPINNER.classList.add('hidden'); 
        }
        
        function playCorrectSound() {
            if (!isSoundEnabled) return;
            generateTone(700, 0.08, 0.1, 0.5); 
        }

        function playWrongSound() {
            if (!isSoundEnabled) return;
            generateTone(200, 0.15, 0.3, 0.05); 
        }

        function generateTone(frequency, startVolume, endVolume, duration) {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(startVolume, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(endVolume, audioContext.currentTime + duration);

                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // Ignore audio context errors on some mobile browsers
            }
        }

        function playClickSound() {
            if (!isSoundEnabled) return;
            generateTone(440, 0.1, 0.001, 0.05);
        }

        let voices = [];
        let voiceLoadInterval = null;

        function loadVoices() {
            voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                clearInterval(voiceLoadInterval);
            }
        }

        loadVoices();
        if (window.speechSynthesis) {
            voiceLoadInterval = setInterval(loadVoices, 500);
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }
        
        // FUNGSI TTS KRITIKAL (Kemas Kini untuk Fokus Suara BM)
        function speakText(text, lang) {
            if (!isSoundEnabled || !window.speechSynthesis) {
                AUDIO_MESSAGE.textContent = lang === 'ms' ? 'Suara tidak disokong atau dimatikan.' : 'Voice not supported or turned off.';
                return;
            }

            stopSpeaking(); 
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (lang === 'ms') {
                utterance.rate = 1.0; 
                utterance.pitch = 1.1; 
                
                // KEUTAMAAN 1: TETAPKAN KOD BAHASA PALING JELAS (ms-MY)
                utterance.lang = 'ms-MY'; 
                
                // KEUTAMAAN 2: CUBA CARI DAN TETAPKAN SUARA BM/ID YANG ADA
                const malayVoice = voices.find(voice => voice.lang.includes('ms') || voice.lang.includes('id'));
                if (malayVoice) {
                    utterance.voice = malayVoice;
                    utterance.lang = malayVoice.lang; 
                }
                
            } else if (lang === 'en') {
                utterance.rate = 1.0; 
                utterance.pitch = 1.0;
                utterance.lang = 'en-US'; 
                
                // KEUTAMAAN BI: CUBA CARI SUARA ENGLISH YANG ADA
                const englishVoice = voices.find(voice => voice.lang.includes('en'));
                if (englishVoice) {
                    utterance.voice = englishVoice;
                    utterance.lang = englishVoice.lang;
                }
            }
            
            isSpeaking = true;
            SPEAK_BUTTON.disabled = true;
            
            const quizCompleteMessage = lang === 'ms' ? 
                `Tahniah! Sifir ${currentMultiplier} telah selesai. Skor akhir: ${score}/${MAX_QUESTIONS}` : 
                `Congratulations! The ${currentMultiplier} times table is complete. Final score: ${score}/${MAX_QUESTIONS}`;

            utterance.onend = () => {
                isSpeaking = false;
                SPEAK_BUTTON.disabled = false;
                if (!isQuizMode || quizQuestionsLeft.length === 0) {
                    SPEAK_TEXT.textContent = isQuizMode ? 
                        (lang === 'ms' ? 'Sifir Selesai!' : 'Table Done!') : 
                        (lang === 'ms' ? 'Baca Sifir Ini' : 'Read Table');
                        
                    if (isQuizMode && quizQuestionsLeft.length === 0) {
                         AUDIO_MESSAGE.textContent = quizCompleteMessage;
                    }
                }
            };

            utterance.onerror = (e) => {
                console.error("Ralat TTS pelayar:", e);
                AUDIO_MESSAGE.textContent = lang === 'ms' ? `Ralat suara: ${e.error}` : `Voice error: ${e.error}`;
                stopSpeaking();
            };

            window.speechSynthesis.speak(utterance);
        }
        
        // FUNGSI SPEAKTABLE KRITIKAL (Kemas Kini untuk Mencegah Mix BM/BI)
        function speakTable() {
            if (!isSoundEnabled) {
                AUDIO_MESSAGE.textContent = currentLanguage === 'ms' ? 'Bunyi dimatikan.' : 'Sound is muted.';
                return;
            }

            if (isSpeaking) {
                stopSpeaking();
                return;
            }
            
            const noQuestionsMessage = currentLanguage === 'ms' ? 
                `Semua ${MAX_QUESTIONS} soalan sifir ${currentMultiplier} telah ditanya. Tukar sifir atau mod.` : 
                `All ${MAX_QUESTIONS} questions for the ${currentMultiplier} times table have been asked. Change multiplier or mode.`;
            
            if (isQuizMode && quizQuestionsLeft.length === 0) {
                AUDIO_MESSAGE.textContent = noQuestionsMessage;
                SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Sifir Selesai!' : 'Table Done!';
                return;
            }

            SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Bercakap... (Klik untuk berhenti)' : 'Speaking... (Click to stop)';
            
            let textToSpeak;
            if (isQuizMode) {
                const randomIndex = Math.floor(Math.random() * quizQuestionsLeft.length);
                const factor2 = quizQuestionsLeft[randomIndex]; 
                const result = currentMultiplier * factor2;
                
                quizTarget = { factor1: currentMultiplier, factor2: factor2, result: result, questionIndex: randomIndex }; 
                
                if (currentLanguage === 'ms') {
                    // MENGGUNAKAN NOMBOR DAN TEKS BM SAHAJA UNTUK MENCEGAH SEBUTAN 'ONE'
                    textToSpeak = `${currentMultiplier} darab ${factor2} sama dengan berapa? Jawab sekarang.`;
                } else { 
                    const { num1Spelled, num2Spelled } = getSpelledEnglish(currentMultiplier, factor2);
                    textToSpeak = `${num1Spelled} times ${num2Spelled} equals what? Answer now.`;
                }
                
                SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 
                    `Sila Jawab: ${currentMultiplier} x ${factor2} = ?` : 
                    `Answer Now: ${currentMultiplier} x ${factor2} = ?`;

            } else {
                if (currentLanguage === 'ms') {
                    // MENGGUNAKAN NOMBOR DAN TEKS BM SAHAJA UNTUK MENCEGAH SEBUTAN 'ONE'
                    textToSpeak = `Ini ialah sifir darab ${currentMultiplier}. `;
                    for (let i = 1; i <= 12; i++) {
                        textToSpeak += `${currentMultiplier} darab ${i} sama dengan ${currentMultiplier * i}. `;
                    }
                    textToSpeak += `Itu sahaja sifir ${currentMultiplier}.`; 
                } else { 
                    const currentMultiplierSpelled = numberToEnglishWords(currentMultiplier);
                    textToSpeak = `This is the ${currentMultiplierSpelled} times table. `;
                    for (let i = 1; i <= 12; i++) {
                        const { num2Spelled, resultSpelled } = getSpelledEnglish(currentMultiplier, i);
                        textToSpeak += `${currentMultiplierSpelled} times ${num2Spelled} equals ${resultSpelled}. `;
                    }
                    textToSpeak += `That is the ${currentMultiplierSpelled} times table.`; 
                }
            }
            
            speakText(textToSpeak, currentLanguage);
        }
        
        // --- 5. Logik Aplikasi Utama (UI/Mode Logic) ---

        function updateScoreDisplay() {
            CURRENT_SCORE.textContent = score;
            TOTAL_ATTEMPTS.textContent = MAX_QUESTIONS; 
            REMAINING_QUESTIONS.textContent = currentLanguage === 'ms' ? 
                `Soalan Belum Ditanya: ${quizQuestionsLeft.length}` : 
                `Questions Remaining: ${quizQuestionsLeft.length}`;
        }
        
        function resetQuizForMultiplier() {
            quizQuestionsLeft = Array.from({ length: MAX_QUESTIONS }, (_, i) => i + 1);
            score = 0;
            quizTarget = null;
            updateScoreDisplay();
        }

        function populateMultiplierSelect() {
            MULTIPLIER_SELECT.innerHTML = '';
            for (let i = MIN_MULTIPLIER; i <= MAX_MULTIPLIER; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = currentLanguage === 'ms' ? `Sifir ${i}` : `Table of ${i}`;
                MULTIPLIER_SELECT.appendChild(option);
            }
        }

        function updateUIText() {
            LOGOUT_BUTTON.textContent = currentLanguage === 'ms' ? 'Log Keluar / Logout' : 'Logout';
            
            document.querySelector('h1').textContent = currentLanguage === 'ms' ? 'Nota Sifir Bercakap' : 'Speaking Times Table';
            
            if (isQuizMode) {
                MODE_TOGGLE_BUTTON.textContent = currentLanguage === 'ms' ? 'Tukar ke Mod Nota' : 'Switch to Note Mode';
                SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Tanya Soalan' : 'Ask Question'; 
            } else {
                MODE_TOGGLE_BUTTON.textContent = currentLanguage === 'ms' ? 'Tukar ke Mod Kuiz' : 'Switch to Quiz Mode';
                SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Baca Sifir Ini' : 'Read Table'; 
            }
            
            PREV_BUTTON.lastChild.textContent = currentLanguage === 'ms' ? 'Sebelum' : 'Previous';
            NEXT_BUTTON.lastChild.textContent = currentLanguage === 'ms' ? 'Seterusnya' : 'Next';
            document.querySelector('label[for="multiplier-select"]').textContent = currentLanguage === 'ms' ? 'Pilih Sifir Darab:' : 'Select Times Table:';

            if (isQuizMode) {
                document.querySelector('#score-display').firstChild.textContent = currentLanguage === 'ms' ? 'Skor: ' : 'Score: ';
            }
            
            populateMultiplierSelect();
            updateSifirDisplay();
            updateScoreDisplay(); 
        }
        
        function toggleLanguage(lang) {
            if (currentLanguage === lang) return;
            currentLanguage = lang;
            stopSpeaking(); 
            
            if (lang === 'ms') {
                LANG_MS_BUTTON.classList.add('bg-prime', 'hover:bg-blue-600', 'text-white');
                LANG_MS_BUTTON.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
                LANG_EN_BUTTON.classList.remove('bg-prime', 'hover:bg-blue-600', 'text-white');
                LANG_EN_BUTTON.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
            } else {
                LANG_EN_BUTTON.classList.add('bg-prime', 'hover:bg-blue-600', 'text-white');
                LANG_EN_BUTTON.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
                LANG_MS_BUTTON.classList.remove('bg-prime', 'hover:bg-blue-600', 'text-white');
                LANG_MS_BUTTON.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
            }

            updateUIText();
        }
        

        function toggleQuizMode() {
            isQuizMode = !isQuizMode;
            
            if (isQuizMode) {
                MODE_TOGGLE_BUTTON.classList.remove('bg-yellow-400', 'hover:bg-yellow-500', 'text-gray-900');
                MODE_TOGGLE_BUTTON.classList.add('bg-pink-500', 'hover:bg-pink-600', 'text-white');
                SCORE_DISPLAY.classList.remove('hidden'); 
                resetQuizForMultiplier(); 
            } else {
                MODE_TOGGLE_BUTTON.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'text-gray-900');
                MODE_TOGGLE_BUTTON.classList.remove('bg-pink-500', 'hover:bg-pink-600', 'text-white');
                SCORE_DISPLAY.classList.add('hidden'); 
            }
            
            stopSpeaking(); 
            updateUIText(); 
        }

        function updateSoundToggleUI() {
            if (isSoundEnabled) {
                SOUND_ICON_ON.classList.remove('hidden');
                SOUND_ICON_OFF.classList.add('hidden');
                SOUND_TEXT.textContent = currentLanguage === 'ms' ? 'Bunyi' : 'Sound On'; 
                SOUND_TOGGLE_BUTTON.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                SOUND_TOGGLE_BUTTON.classList.add('bg-green-100', 'hover:bg-green-200', 'text-green-700');
            } else {
                SOUND_ICON_ON.classList.add('hidden');
                SOUND_ICON_OFF.classList.remove('hidden');
                SOUND_TEXT.textContent = currentLanguage === 'ms' ? 'Senyap' : 'Mute'; 
                SOUND_TOGGLE_BUTTON.classList.remove('bg-green-100', 'hover:bg-green-200', 'text-green-700');
                SOUND_TOGGLE_BUTTON.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            }
        }

        function updateSifirDisplay() {
            MULTIPLIER_SELECT.value = currentMultiplier; 

            SIFIR_LIST.innerHTML = '';
            
            const answeredFactors = isQuizMode ? 
                Array.from({ length: MAX_QUESTIONS }, (_, i) => i + 1)
                .filter(factor => !quizQuestionsLeft.includes(factor)) : [];

            for (let i = 1; i <= 12; i++) {
                const result = currentMultiplier * i;
                const equationDiv = document.createElement('div');
                const rowClass = i % 2 !== 0 ? 'bg-pink-50' : 'bg-green-50'; 
                
                equationDiv.className = `equation flex justify-between items-center p-3 md:px-5 font-mono ${rowClass} hover:bg-yellow-100 transition duration-100`;
                
                equationDiv.addEventListener('mouseover', playClickSound);
                equationDiv.addEventListener('touchstart', playClickSound);
                
                let answerHtml;
                
                if (isQuizMode) {
                    const isAnswered = answeredFactors.includes(i);
                    const answeredClass = isAnswered ? 'bg-green-500 text-white answered' : 'bg-gray-200 text-gray-200 hover:bg-gray-300 hover:text-gray-300 cursor-pointer';

                    answerHtml = `<span 
                                    data-result="${result}"
                                    data-factor2="${i}"
                                    class="answer-box font-extrabold select-none px-4 rounded-md text-3xl transition duration-200 ${answeredClass}">
                                    ${isAnswered ? result : '?'}
                                </span>`;
                } else {
                    answerHtml = `<span class="font-extrabold text-green-800 text-3xl">${result}</span>`;
                }
                
                equationDiv.innerHTML = `
                    <span class="font-extrabold text-maroon text-3xl">${currentMultiplier}</span>
                    <span class="text-gray-900 text-3xl">x</span>
                    <span class="font-extrabold text-maroon text-3xl">${i}</span>
                    <span class="text-gray-900 text-3xl">=</span>
                    ${answerHtml}
                `;
                SIFIR_LIST.appendChild(equationDiv);
            }

            PREV_BUTTON.disabled = currentMultiplier === MIN_MULTIPLIER;
            NEXT_BUTTON.disabled = currentMultiplier === MAX_MULTIPLIER;
            
            if (isQuizMode) {
                 SPEAK_BUTTON.disabled = quizQuestionsLeft.length === 0;
            } else {
                 SPEAK_BUTTON.disabled = false;
            }

            if (isQuizMode) updateScoreDisplay();
        }

        function goToNextSifir() {
            if (currentMultiplier < MAX_MULTIPLIER) {
                currentMultiplier++;
                resetQuizForMultiplier(); 
                updateSifirDisplay();
            }
        }

        function goToPrevSifir() {
            if (currentMultiplier > MIN_MULTIPLIER) {
                currentMultiplier--;
                resetQuizForMultiplier(); 
                updateSifirDisplay();
            }
        }
        
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            updateSoundToggleUI();
            stopSpeaking(); 
            
            if (isSoundEnabled && audioContext && audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("Ralat semasa resume AudioContext:", e));
            }
        }

        function handleQuizClick(event) {
            if (!isQuizMode) return;
            
            const clickedElement = event.target.closest('.answer-box');
            
            if (clickedElement && !clickedElement.classList.contains('answered')) {
                const clickedFactor2 = parseInt(clickedElement.getAttribute('data-factor2'), 10);
                const clickedResult = parseInt(clickedElement.getAttribute('data-result'), 10);
                
                let correctMessage;
                let wrongMessage;
                let noQuestionMessage;
                
                if (currentLanguage === 'ms') {
                    correctMessage = `BETUL! ${quizTarget.factor1} x ${quizTarget.factor2} = ${quizTarget.result}`;
                    wrongMessage = 'Salah. Anda klik soalan lain. Soalan semasa ialah ' + `${quizTarget.factor1} x ${quizTarget.factor2}`;
                    noQuestionMessage = 'Sila tekan "Tanya Soalan" dahulu.';
                } else {
                    correctMessage = `CORRECT! ${quizTarget.factor1} x ${quizTarget.factor2} = ${quizTarget.result}`;
                    wrongMessage = 'Wrong. You clicked another question. The current question is ' + `${quizTarget.factor1} x ${quizTarget.factor2}`;
                    noQuestionMessage = 'Please press "Ask Question" first.';
                }
                
                if (quizTarget && clickedFactor2 === quizTarget.factor2) {
                    score++;
                    playCorrectSound();
                    AUDIO_MESSAGE.textContent = correctMessage;
                    
                    quizQuestionsLeft.splice(quizTarget.questionIndex, 1);
                    
                    clickedElement.textContent = clickedResult;
                    clickedElement.classList.remove('bg-gray-200', 'text-gray-200', 'hover:bg-gray-300', 'hover:text-gray-300', 'cursor-pointer');
                    clickedElement.classList.add('bg-green-500', 'text-white', 'answered');
                    
                    quizTarget = null;
                    
                    updateScoreDisplay(); 
                    if (quizQuestionsLeft.length > 0) {
                        SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Tanya Soalan' : 'Ask Question';
                    } else {
                         SPEAK_BUTTON.disabled = true;
                         SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Sifir Selesai!' : 'Table Done!';
                         AUDIO_MESSAGE.textContent += currentLanguage === 'ms' ? ` (Sifir ${currentMultiplier} SELESAI!)` : ` (Table ${currentMultiplier} DONE!)`;
                    }
                    
                } else if (!quizTarget) {
                    AUDIO_MESSAGE.textContent = noQuestionMessage;
                    playWrongSound();
                    
                } else {
                    playWrongSound();
                    AUDIO_MESSAGE.textContent = wrongMessage;
                    
                    clickedElement.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                    clickedElement.classList.add('bg-red-500', 'hover:bg-red-500');

                    setTimeout(() => {
                        clickedElement.classList.remove('bg-red-500', 'hover:bg-red-500');
                        clickedElement.classList.add('bg-gray-200', 'hover:bg-gray-300');
                    }, 500); 
                }
            }
        }

        function toggleTTSInfo() {
            const isHidden = TTS_INFO_CONTENT.classList.contains('hidden');
            if (isHidden) {
                TTS_INFO_CONTENT.classList.remove('hidden');
                TTS_INFO_ICON.classList.add('rotate-180'); 
            } else {
                TTS_INFO_CONTENT.classList.add('hidden');
                TTS_INFO_ICON.classList.remove('rotate-180');
            }
        }

        // --- 6. Inisialisasi Aplikasi (Initialization) ---
        
        async function initApp() {
            toggleLanguage('ms'); 
            
            updateSoundToggleUI();
            populateMultiplierSelect(); 
            resetQuizForMultiplier(); 
            updateSifirDisplay(); 
            updateUIText(); 
            
            // Daftarkan Pendengar Acara Aplikasi
            NEXT_BUTTON.addEventListener('click', goToNextSifir);
            PREV_BUTTON.addEventListener('click', goToPrevSifir);
            SPEAK_BUTTON.addEventListener('click', speakTable); 
            MODE_TOGGLE_BUTTON.addEventListener('click', toggleQuizMode); 
            MULTIPLIER_SELECT.addEventListener('change', (event) => {
                const newMultiplier = parseInt(event.target.value, 10);
                if (!isNaN(newMultiplier) && newMultiplier >= MIN_MULTIPLIER && newMultiplier <= MAX_MULTIPLIER) {
                    currentMultiplier = newMultiplier;
                    resetQuizForMultiplier(); 
                    updateSifirDisplay();
                }
            });
            SOUND_TOGGLE_BUTTON.addEventListener('click', toggleSound);
            SIFIR_LIST.addEventListener('click', handleQuizClick); 
            TTS_INFO_TOGGLE.addEventListener('click', toggleTTSInfo);
            LANG_MS_BUTTON.addEventListener('click', () => toggleLanguage('ms'));
            LANG_EN_BUTTON.addEventListener('click', () => toggleLanguage('en'));
            
            console.log("App Initialized.");
        }
        
        // --- 7. Inisialisasi Halaman (Page Initialization) ---
        
        window.onload = function() {
            if (LOGIN_BUTTON) {
                LOGIN_BUTTON.addEventListener('click', attemptLogin);
            } else
