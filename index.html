<script type="module">
    // --- 1. Konfigurasi dan Pembolehubah Global ---
    const SECRET_PASSWORD = "notasifir5973"; 
    
    // Pembolehubah Bahasa Baru
    let currentLanguage = 'ms'; 
    
    // Pembolehubah DOM untuk Log Masuk (Diperlukan oleh window.onload)
    const LOGIN_SCREEN = document.getElementById('login-screen');
    const APP_CONTAINER = document.getElementById('app-container');
    const PASSWORD_INPUT = document.getElementById('password-input');
    const LOGIN_BUTTON = document.getElementById('login-button'); 
    const LOGIN_MESSAGE = document.getElementById('login-message');
    
    // Pembolehubah DOM Aplikasi Sifir (Diperlukan oleh initApp)
    const LANG_MS_BUTTON = document.getElementById('lang-ms-button');
    const LANG_EN_BUTTON = document.getElementById('lang-en-button');
    const SPEAK_BUTTON = document.getElementById('speak-button');
    const SPEAK_TEXT = document.getElementById('speak-text');
    const LOADING_SPINNER = document.getElementById('loading-spinner');
    const AUDIO_MESSAGE = document.getElementById('audio-message');
    const SIFIR_LIST = document.getElementById('sifir-list');
    const PREV_BUTTON = document.getElementById('prev-button');
    const NEXT_BUTTON = document.getElementById('next-button');
    const MULTIPLIER_SELECT = document.getElementById('multiplier-select'); 
    const MODE_TOGGLE_BUTTON = document.getElementById('mode-toggle'); 
    const SCORE_DISPLAY = document.getElementById('score-display'); 
    const CURRENT_SCORE = document.getElementById('current-score'); 
    const TOTAL_ATTEMPTS = document.getElementById('total-attempts'); 
    const REMAINING_QUESTIONS = document.getElementById('remaining-questions'); 
    const SOUND_TOGGLE_BUTTON = document.getElementById('sound-toggle-button');
    const SOUND_ICON_ON = document.getElementById('sound-icon-on');
    const SOUND_ICON_OFF = document.getElementById('sound-icon-off');
    const SOUND_TEXT = document.getElementById('sound-text');
    const TTS_INFO_TOGGLE = document.getElementById('tts-info-toggle');
    const TTS_INFO_CONTENT = document.getElementById('tts-info-content');
    const TTS_INFO_ICON = document.getElementById('tts-info-icon');
    
    // Pembolehubah Butang Log Keluar
    const LOGOUT_BUTTON = document.getElementById('logout-button'); 
    
    // Pembolehubah Kawalan
    let isSoundEnabled = true; 
    let isSpeaking = false;
    let isQuizMode = false; 
    let currentMultiplier = 1;
    const MIN_MULTIPLIER = 1;
    const MAX_MULTIPLIER = 12;

    let audioContext; 
    let score = 0;
    const MAX_QUESTIONS = 12; 
    let quizQuestionsLeft = []; 
    let quizTarget = null; 
    
    // --- 2. Fungsi Bantuan Bahasa & Logik ---

    function numberToEnglishWords(num) {
        if (num === 0) return 'zero';
        if (num > 1000) return num.toString(); 
        
        const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine', 'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
        const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        
        if (num < 20) return units[num];
        if (num < 100) return tens[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + units[num % 10] : '');
        
        const h = Math.floor(num / 100);
        const rem = num % 100;
        let str = units[h] + ' hundred';
        if (rem > 0) {
            str += ' and ' + numberToEnglishWords(rem); 
        }
        return str.trim(); 
    }

    function getSpelledEnglish(num1, num2) {
        const result = num1 * num2;
        const num1Spelled = numberToEnglishWords(num1);
        const num2Spelled = numberToEnglishWords(num2);
        const resultSpelled = numberToEnglishWords(result);
        return { num1Spelled, num2Spelled, resultSpelled };
    }

    // --- 3. Logik Log Masuk & Log Keluar ---
    
    function attemptLogin() {
        if (LOGIN_BUTTON.disabled) return;
        LOGIN_BUTTON.disabled = true;

        const enteredPassword = PASSWORD_INPUT.value.trim().toLowerCase();
        
        if (enteredPassword === SECRET_PASSWORD) {
            LOGIN_SCREEN.classList.add('hidden');
            APP_CONTAINER.classList.remove('hidden');
            LOGIN_MESSAGE.classList.add('hidden');
            initApp();
        } else {
            LOGIN_MESSAGE.textContent = 'Kata laluan salah. Sila cuba lagi.';
            LOGIN_MESSAGE.classList.remove('hidden');
            PASSWORD_INPUT.value = ''; 
            PASSWORD_INPUT.focus();
        }
        
        setTimeout(() => { LOGIN_BUTTON.disabled = false; }, 500);
    }
    
    function logout() {
        stopSpeaking(); 
        
        APP_CONTAINER.classList.add('hidden');
        LOGIN_SCREEN.classList.remove('hidden');
        
        PASSWORD_INPUT.value = '';
        LOGIN_MESSAGE.classList.add('hidden');
        PASSWORD_INPUT.focus();
        
        if (isQuizMode) {
            toggleQuizMode(); 
        }
    }
    
    // --- 4. Fungsi Audio & TTS (TTS & Bunyi) ---
    
    function stopSpeaking() {
        if (window.speechSynthesis && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
        }
        isSpeaking = false;
        
        SPEAK_TEXT.textContent = isQuizMode ? 
            (currentLanguage === 'ms' ? 'Tanya Soalan' : 'Ask Question') : 
            (currentLanguage === 'ms' ? 'Baca Sifir Ini' : 'Read Table');
            
        SPEAK_BUTTON.disabled = false;
        AUDIO_MESSAGE.textContent = '';
        LOADING_SPINNER.classList.add('hidden'); 
    }
    
    function playCorrectSound() {
        if (!isSoundEnabled) return;
        generateTone(700, 0.08, 0.1, 0.5); 
    }

    function playWrongSound() {
        if (!isSoundEnabled) return;
        generateTone(200, 0.15, 0.3, 0.05); 
    }

    function generateTone(frequency, startVolume, endVolume, duration) {
        try {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(startVolume, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(endVolume, audioContext.currentTime + duration);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
        } catch (e) {
            // Ignore audio context errors on some mobile browsers
        }
    }

    function playClickSound() {
        if (!isSoundEnabled) return;
        generateTone(440, 0.1, 0.001, 0.05);
    }

    let voices = [];
    let voiceLoadInterval = null;

    function loadVoices() {
        voices = window.speechSynthesis.getVoices();
        if (voices.length > 0) {
            clearInterval(voiceLoadInterval);
        }
    }

    loadVoices();
    if (window.speechSynthesis) {
        voiceLoadInterval = setInterval(loadVoices, 500);
        window.speechSynthesis.onvoiceschanged = loadVoices;
    }

    function speakText(text, lang) {
        if (!isSoundEnabled || !window.speechSynthesis) {
            AUDIO_MESSAGE.textContent = lang === 'ms' ? 'Suara tidak disokong atau dimatikan.' : 'Voice not supported or turned off.';
            return;
        }

        stopSpeaking(); 
        
        const utterance = new SpeechSynthesisUtterance(text);
        
        let preferredVoice = null;
        
        if (lang === 'ms') {
            utterance.rate = 1.0; 
            utterance.pitch = 1.1; 
            
            // --- LOGIK PRIORITI SUARA MELAYU (Msia vs Indonesia) ---
            
            // Keutamaan 1: Suara Wanita Bahasa Melayu Malaysia (ms-MY)
            const malayFemaleMY = voices.find(voice => 
                voice.lang.includes('ms-MY') && 
                (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('perempuan') || voice.name.toLowerCase().includes('suri'))
            );
            
            // Keutamaan 2: Mana-mana Suara Bahasa Melayu Malaysia (ms-MY)
            const malayVoiceMY = voices.find(voice => voice.lang.includes('ms-MY'));

            // Keutamaan 3: Suara Wanita Bahasa Indonesia (id-ID) - sebagai fallback
             const malayFemaleID = voices.find(voice => 
                voice.lang.includes('id-ID') && 
                (voice.name.toLowerCase().includes('female') || voice.name.toLowerCase().includes('perempuan') || voice.name.toLowerCase().includes('suri'))
            );

            preferredVoice = malayFemaleMY || malayVoiceMY || malayFemaleID;
            
            // Tetapkan suara atau fallback
            if (preferredVoice) {
                utterance.voice = preferredVoice;
                utterance.lang = preferredVoice.lang;
            } else {
                utterance.lang = 'ms-MY'; // Fallback paling asas untuk sebutan
            }
            // --- END LOGIK PRIORITI SUARA MELAYU ---
            
        } else if (lang === 'en') {
            utterance.rate = 1.0; 
            utterance.pitch = 1.0;
            
            const englishVoice = voices.find(voice => 
                voice.lang.includes('en') && 
                (voice.name.toLowerCase().includes('us') || voice.name.toLowerCase().includes('united states') || voice.name.toLowerCase().includes('uk'))
            );

            preferredVoice = englishVoice || voices.find(voice => voice.lang.includes('en'));
            
            if (preferredVoice) {
                utterance.voice = preferredVoice;
                utterance.lang = preferredVoice.lang;
            } else {
                utterance.lang = 'en-US'; // Fallback
            }
        }
        
        isSpeaking = true;
        SPEAK_BUTTON.disabled = true;
        
        const quizCompleteMessage = lang === 'ms' ? 
            `Tahniah! Sifir ${currentMultiplier} telah selesai. Skor akhir: ${score}/${MAX_QUESTIONS}` : 
            `Congratulations! The ${currentMultiplier} times table is complete. Final score: ${score}/${MAX_QUESTIONS}`;

        utterance.onend = () => {
            isSpeaking = false;
            SPEAK_BUTTON.disabled = false;
            if (!isQuizMode || quizQuestionsLeft.length === 0) {
                SPEAK_TEXT.textContent = isQuizMode ? 
                    (lang === 'ms' ? 'Sifir Selesai!' : 'Table Done!') : 
                    (lang === 'ms' ? 'Baca Sifir Ini' : 'Read Table');
                    
                if (isQuizMode && quizQuestionsLeft.length === 0) {
                     AUDIO_MESSAGE.textContent = quizCompleteMessage;
                }
            }
        };

        utterance.onerror = (e) => {
            console.error("Ralat TTS pelayar:", e);
            AUDIO_MESSAGE.textContent = lang === 'ms' ? `Ralat suara: ${e.error}` : `Voice error: ${e.error}`;
            stopSpeaking();
        };

        window.speechSynthesis.speak(utterance);
    }
    
    function speakTable() {
        if (!isSoundEnabled) {
            AUDIO_MESSAGE.textContent = currentLanguage === 'ms' ? 'Bunyi dimatikan.' : 'Sound is muted.';
            return;
        }

        if (isSpeaking) {
            stopSpeaking();
            return;
        }
        
        const noQuestionsMessage = currentLanguage === 'ms' ? 
            `Semua ${MAX_QUESTIONS} soalan sifir ${currentMultiplier} telah ditanya. Tukar sifir atau mod.` : 
            `All ${MAX_QUESTIONS} questions for the ${currentMultiplier} times table have been asked. Change multiplier or mode.`;
        
        if (isQuizMode && quizQuestionsLeft.length === 0) {
            AUDIO_MESSAGE.textContent = noQuestionsMessage;
            SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Sifir Selesai!' : 'Table Done!';
            return;
        }

        SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Bercakap... (Klik untuk berhenti)' : 'Speaking... (Click to stop)';
        
        let textToSpeak;
        if (isQuizMode) {
            const randomIndex = Math.floor(Math.random() * quizQuestionsLeft.length);
            const factor2 = quizQuestionsLeft[randomIndex]; 
            const result = currentMultiplier * factor2;
            
            quizTarget = { factor1: currentMultiplier, factor2: factor2, result: result, questionIndex: randomIndex }; 
            
            if (currentLanguage === 'ms') {
                // PEMBETULAN: Menggunakan nombor terus (1, 2, 3...) dalam teks untuk memaksa TTS BM membaca sebagai "satu, dua, tiga..."
                textToSpeak = `${currentMultiplier} darab ${factor2} sama dengan berapa? Jawab sekarang.`;
            } else { 
                // Kekalkan fungsi BI sedia ada
                const { num1Spelled, num2Spelled } = getSpelledEnglish(currentMultiplier, factor2);
                textToSpeak = `${num1Spelled} times ${num2Spelled} equals what? Answer now.`;
            }
            
            SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 
                `Sila Jawab: ${currentMultiplier} x ${factor2} = ?` : 
                `Answer Now: ${currentMultiplier} x ${factor2} = ?`;

        } else {
            if (currentLanguage === 'ms') {
                // Mod Nota BM (Sudah betul: menggunakan nombor terus)
                textToSpeak = `Ini ialah sifir darab ${currentMultiplier}. `;
                for (let i = 1; i <= 12; i++) {
                    textToSpeak += `${currentMultiplier} darab ${i} sama dengan ${currentMultiplier * i}. `;
                }
                textToSpeak += `Itu sahaja sifir ${currentMultiplier}.`; 
            } else { 
                // Mod Nota BI (Kekalkan)
                const currentMultiplierSpelled = numberToEnglishWords(currentMultiplier);
                textToSpeak = `This is the ${currentMultiplierSpelled} times table. `;
                for (let i = 1; i <= 12; i++) {
                    const { num2Spelled, resultSpelled } = getSpelledEnglish(currentMultiplier, i);
                    textToSpeak += `${currentMultiplierSpelled} times ${num2Spelled} equals ${resultSpelled}. `;
                }
                textToSpeak += `That is the ${currentMultiplierSpelled} times table.`; 
            }
        }
        
        speakText(textToSpeak, currentLanguage);
    }

    // --- 5. Logik Aplikasi Utama (UI/Mode Logic) ---
    
    function updateScoreDisplay() {
        CURRENT_SCORE.textContent = score;
        TOTAL_ATTEMPTS.textContent = MAX_QUESTIONS; 
        REMAINING_QUESTIONS.textContent = currentLanguage === 'ms' ? 
            `Soalan Belum Ditanya: ${quizQuestionsLeft.length}` : 
            `Questions Remaining: ${quizQuestionsLeft.length}`;
    }
    
    function resetQuizForMultiplier() {
        quizQuestionsLeft = Array.from({ length: MAX_QUESTIONS }, (_, i) => i + 1);
        score = 0;
        quizTarget = null;
        updateScoreDisplay();
    }

    function populateMultiplierSelect() {
        MULTIPLIER_SELECT.innerHTML = '';
        for (let i = MIN_MULTIPLIER; i <= MAX_MULTIPLIER; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = currentLanguage === 'ms' ? `Sifir ${i}` : `Table of ${i}`;
            MULTIPLIER_SELECT.appendChild(option);
        }
    }

    function updateUIText() {
        LOGOUT_BUTTON.textContent = currentLanguage === 'ms' ? 'Log Keluar / Logout' : 'Logout';
        
        document.querySelector('h1').textContent = currentLanguage === 'ms' ? 'Nota Sifir Bercakap' : 'Speaking Times Table';
        
        if (isQuizMode) {
            MODE_TOGGLE_BUTTON.textContent = currentLanguage === 'ms' ? 'Tukar ke Mod Nota' : 'Switch to Note Mode';
            SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Tanya Soalan' : 'Ask Question'; 
        } else {
            MODE_TOGGLE_BUTTON.textContent = currentLanguage === 'ms' ? 'Tukar ke Mod Kuiz' : 'Switch to Quiz Mode';
            SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Baca Sifir Ini' : 'Read Table'; 
        }
        
        PREV_BUTTON.lastChild.textContent = currentLanguage === 'ms' ? 'Sebelum' : 'Previous';
        NEXT_BUTTON.lastChild.textContent = currentLanguage === 'ms' ? 'Seterusnya' : 'Next';
        document.querySelector('label[for="multiplier-select"]').textContent = currentLanguage === 'ms' ? 'Pilih Sifir Darab:' : 'Select Times Table:';

        if (isQuizMode) {
            document.querySelector('#score-display').firstChild.textContent = currentLanguage === 'ms' ? 'Skor: ' : 'Score: ';
        }
        
        populateMultiplierSelect();
        updateSifirDisplay();
        updateScoreDisplay(); 
    }
    
    function toggleLanguage(lang) {
        if (currentLanguage === lang) return;
        currentLanguage = lang;
        stopSpeaking(); 
        
        if (lang === 'ms') {
            LANG_MS_BUTTON.classList.add('bg-prime', 'hover:bg-blue-600', 'text-white');
            LANG_MS_BUTTON.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
            LANG_EN_BUTTON.classList.remove('bg-prime', 'hover:bg-blue-600', 'text-white');
            LANG_EN_BUTTON.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
        } else {
            LANG_EN_BUTTON.classList.add('bg-prime', 'hover:bg-blue-600', 'text-white');
            LANG_EN_BUTTON.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
            LANG_MS_BUTTON.classList.remove('bg-prime', 'hover:bg-blue-600', 'text-white');
            LANG_MS_BUTTON.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-800');
        }

        updateUIText();
    }
    

    function toggleQuizMode() {
        isQuizMode = !isQuizMode;
        
        if (isQuizMode) {
            MODE_TOGGLE_BUTTON.classList.remove('bg-yellow-400', 'hover:bg-yellow-500', 'text-gray-900');
            MODE_TOGGLE_BUTTON.classList.add('bg-pink-500', 'hover:bg-pink-600', 'text-white');
            SCORE_DISPLAY.classList.remove('hidden'); 
            resetQuizForMultiplier(); 
        } else {
            MODE_TOGGLE_BUTTON.classList.add('bg-yellow-400', 'hover:bg-yellow-500', 'text-gray-900');
            MODE_TOGGLE_BUTTON.classList.remove('bg-pink-500', 'hover:bg-pink-600', 'text-white');
            SCORE_DISPLAY.classList.add('hidden'); 
        }
        
        stopSpeaking(); 
        updateUIText(); 
    }

    function updateSoundToggleUI() {
        if (isSoundEnabled) {
            SOUND_ICON_ON.classList.remove('hidden');
            SOUND_ICON_OFF.classList.add('hidden');
            SOUND_TEXT.textContent = currentLanguage === 'ms' ? 'Bunyi' : 'Sound On'; 
            SOUND_TOGGLE_BUTTON.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            SOUND_TOGGLE_BUTTON.classList.add('bg-green-100', 'hover:bg-green-200', 'text-green-700');
        } else {
            SOUND_ICON_ON.classList.add('hidden');
            SOUND_ICON_OFF.classList.remove('hidden');
            SOUND_TEXT.textContent = currentLanguage === 'ms' ? 'Senyap' : 'Mute'; 
            SOUND_TOGGLE_BUTTON.classList.remove('bg-green-100', 'hover:bg-green-200', 'text-green-700');
            SOUND_TOGGLE_BUTTON.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
        }
    }

    function updateSifirDisplay() {
        MULTIPLIER_SELECT.value = currentMultiplier; 

        SIFIR_LIST.innerHTML = '';
        
        const answeredFactors = isQuizMode ? 
            Array.from({ length: MAX_QUESTIONS }, (_, i) => i + 1)
            .filter(factor => !quizQuestionsLeft.includes(factor)) : [];

        for (let i = 1; i <= 12; i++) {
            const result = currentMultiplier * i;
            const equationDiv = document.createElement('div');
            const rowClass = i % 2 !== 0 ? 'bg-pink-50' : 'bg-green-50'; 
            
            equationDiv.className = `equation flex justify-between items-center p-3 md:px-5 font-mono ${rowClass} hover:bg-yellow-100 transition duration-100`;
            
            equationDiv.addEventListener('mouseover', playClickSound);
            equationDiv.addEventListener('touchstart', playClickSound);
            
            let answerHtml;
            
            if (isQuizMode) {
                const isAnswered = answeredFactors.includes(i);
                const answeredClass = isAnswered ? 'bg-green-500 text-white answered' : 'bg-gray-200 text-gray-200 hover:bg-gray-300 hover:text-gray-300 cursor-pointer';

                answerHtml = `<span 
                                data-result="${result}"
                                data-factor2="${i}"
                                class="answer-box font-extrabold select-none px-4 rounded-md text-3xl transition duration-200 ${answeredClass}">
                                ${isAnswered ? result : '?'}
                              </span>`;
            } else {
                answerHtml = `<span class="font-extrabold text-green-800 text-3xl">${result}</span>`;
            }
            
            equationDiv.innerHTML = `
                <span class="font-extrabold text-maroon text-3xl">${currentMultiplier}</span>
                <span class="text-gray-900 text-3xl">x</span>
                <span class="font-extrabold text-maroon text-3xl">${i}</span>
                <span class="text-gray-900 text-3xl">=</span>
                ${answerHtml}
            `;
            SIFIR_LIST.appendChild(equationDiv);
        }

        PREV_BUTTON.disabled = currentMultiplier === MIN_MULTIPLIER;
        NEXT_BUTTON.disabled = currentMultiplier === MAX_MULTIPLIER;
        
        if (isQuizMode) {
             SPEAK_BUTTON.disabled = quizQuestionsLeft.length === 0;
        } else {
             SPEAK_BUTTON.disabled = false;
        }

        if (isQuizMode) updateScoreDisplay();
    }

    function goToNextSifir() {
        if (currentMultiplier < MAX_MULTIPLIER) {
            currentMultiplier++;
            resetQuizForMultiplier(); 
            updateSifirDisplay();
        }
    }

    function goToPrevSifir() {
        if (currentMultiplier > MIN_MULTIPLIER) {
            currentMultiplier--;
            resetQuizForMultiplier(); 
            updateSifirDisplay();
        }
    }
    
    function toggleSound() {
        isSoundEnabled = !isSoundEnabled;
        updateSoundToggleUI();
        stopSpeaking(); 
        
        if (isSoundEnabled && audioContext && audioContext.state === 'suspended') {
            audioContext.resume().catch(e => console.error("Ralat semasa resume AudioContext:", e));
        }
    }

    function handleQuizClick(event) {
        if (!isQuizMode) return;
        
        const clickedElement = event.target.closest('.answer-box');
        
        if (clickedElement && !clickedElement.classList.contains('answered')) {
            const clickedFactor2 = parseInt(clickedElement.getAttribute('data-factor2'), 10);
            const clickedResult = parseInt(clickedElement.getAttribute('data-result'), 10);
            
            let correctMessage;
            let wrongMessage;
            let noQuestionMessage;
            
            if (currentLanguage === 'ms') {
                correctMessage = `BETUL! ${quizTarget.factor1} x ${quizTarget.factor2} = ${quizTarget.result}`;
                wrongMessage = 'Salah. Anda klik soalan lain. Soalan semasa ialah ' + `${quizTarget.factor1} x ${quizTarget.factor2}`;
                noQuestionMessage = 'Sila tekan "Tanya Soalan" dahulu.';
            } else {
                correctMessage = `CORRECT! ${quizTarget.factor1} x ${quizTarget.factor2} = ${quizTarget.result}`;
                wrongMessage = 'Wrong. You clicked another question. The current question is ' + `${quizTarget.factor1} x ${quizTarget.factor2}`;
                noQuestionMessage = 'Please press "Ask Question" first.';
            }
            
            if (quizTarget && clickedFactor2 === quizTarget.factor2) {
                score++;
                playCorrectSound();
                AUDIO_MESSAGE.textContent = correctMessage;
                
                quizQuestionsLeft.splice(quizTarget.questionIndex, 1);
                
                clickedElement.textContent = clickedResult;
                clickedElement.classList.remove('bg-gray-200', 'text-gray-200', 'hover:bg-gray-300', 'hover:text-gray-300', 'cursor-pointer');
                clickedElement.classList.add('bg-green-500', 'text-white', 'answered');
                
                quizTarget = null;
                
                updateScoreDisplay(); 
                if (quizQuestionsLeft.length > 0) {
                    SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Tanya Soalan' : 'Ask Question';
                } else {
                     SPEAK_BUTTON.disabled = true;
                     SPEAK_TEXT.textContent = currentLanguage === 'ms' ? 'Sifir Selesai!' : 'Table Done!';
                     AUDIO_MESSAGE.textContent += currentLanguage === 'ms' ? ` (Sifir ${currentMultiplier} SELESAI!)` : ` (Table ${currentMultiplier} DONE!)`;
                }
                
            } else if (!quizTarget) {
                AUDIO_MESSAGE.textContent = noQuestionMessage;
                playWrongSound();
                
            } else {
                playWrongSound();
                AUDIO_MESSAGE.textContent = wrongMessage;
                
                clickedElement.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                clickedElement.classList.add('bg-red-500', 'hover:bg-red-500');

                setTimeout(() => {
                    clickedElement.classList.remove('bg-red-500', 'hover:bg-red-500');
                    clickedElement.classList.add('bg-gray-200', 'hover:bg-gray-300');
                }, 500); 
            }
        }
    }

    function toggleTTSInfo() {
        const isHidden = TTS_INFO_CONTENT.classList.contains('hidden');
        if (isHidden) {
            TTS_INFO_CONTENT.classList.remove('hidden');
            TTS_INFO_ICON.classList.add('rotate-180'); 
        } else {
            TTS_INFO_CONTENT.classList.add('hidden');
            TTS_INFO_ICON.classList.remove('rotate-180');
        }
    }

    // --- 6. Inisialisasi Aplikasi (Initialization) ---
    
    async function initApp() {
        toggleLanguage('ms'); 
        
        updateSoundToggleUI();
        populateMultiplierSelect(); 
        resetQuizForMultiplier(); 
        updateSifirDisplay(); 
        updateUIText(); 
        
        // Daftarkan Pendengar Acara Aplikasi
        NEXT_BUTTON.addEventListener('click', goToNextSifir);
        PREV_BUTTON.addEventListener('click', goToPrevSifir);
        SPEAK_BUTTON.addEventListener('click', speakTable); 
        MODE_TOGGLE_BUTTON.addEventListener('click', toggleQuizMode); 
        MULTIPLIER_SELECT.addEventListener('change', (event) => {
            const newMultiplier = parseInt(event.target.value, 10);
            if (!isNaN(newMultiplier) && newMultiplier >= MIN_MULTIPLIER && newMultiplier <= MAX_MULTIPLIER) {
                currentMultiplier = newMultiplier;
                resetQuizForMultiplier(); 
                updateSifirDisplay();
            }
        });
        SOUND_TOGGLE_BUTTON.addEventListener('click', toggleSound);
        SIFIR_LIST.addEventListener('click', handleQuizClick); 
        TTS_INFO_TOGGLE.addEventListener('click', toggleTTSInfo);
        LANG_MS_BUTTON.addEventListener('click', () => toggleLanguage('ms'));
        LANG_EN_BUTTON.addEventListener('click', () => toggleLanguage('en'));
        
        console.log("App Initialized.");
    }
    
    // --- 7. Inisialisasi Halaman (Page Initialization) ---
    
    window.onload = function() {
        if (LOGIN_BUTTON) {
            LOGIN_BUTTON.addEventListener('click', attemptLogin);
        } else {
             console.error("Ralat: Elemen 'login-button' tidak ditemui.");
        }
        
        if (PASSWORD_INPUT) {
             PASSWORD_INPUT.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
            PASSWORD_INPUT.focus();
        } else {
             console.error("Ralat: Elemen 'password-input' tidak ditemui.");
        }
        
        if (LOGOUT_BUTTON) {
            LOGOUT_BUTTON.addEventListener('click', logout);
        } else {
            console.error("Ralat: Elemen 'logout-button' tidak ditemui.");
        }
    };

</script>
